<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gerar Novo Laudo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link href="/css/style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div class="content">
        
        <div class="page-header mb-4">
            <h1>Gerar Novo Laudo</h1>
            <a th:href="@{/exames/importar-pagina}" class="btn btn-outline-primary">
                <i class="fa-solid fa-file-csv me-2"></i>Importar Dados via CSV
            </a>
        </div>

        <form th:action="@{/exames/gerar}" th:object="${laudoRequest}" method="post" enctype="multipart/form-data">
            
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Informações Gerais do Exame</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipoExame" class="form-label">Tipo de Exame:</label>
                            <select id="tipoExame" class="form-select" th:field="*{tipoExame}" onchange="toggleSections()">
                                <option value="HEMOGRAMA_AGRUPADO">Hemograma Agrupado (via CSV)</option>
                                <option value="GLICOSE">Glicose (Entrada Manual)</option>
                                <option value="UREIA">Ureia (Entrada Manual)</option>
                                <option value="CREATININA">Creatinina (Entrada Manual)</option>
                                <option value="RAIO_X">Raio-X (Entrada Manual)</option>
                                <option value="RESSONANCIA">Ressonância Magnética (Entrada Manual)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="formato" class="form-label">Formato de Saída:</label>
                            <select id="formato" class="form-select" th:field="*{formato}">
                                <option value="html">HTML</option>
                                <option value="pdf">PDF</option>
                                <option value="txt">Texto Simples</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div id="subExamesContainer" class="card mb-4" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title mb-3">Selecione os Exames do Hemograma</h5>
                    <div class="row">
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="HEMOGRAMA_COMPLETO" id="sub1" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub1">Hemograma Completo</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="GLICEMIA" id="sub2" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub2">Glicemia</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="UREIA" id="sub3" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub3">Ureia</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="CREATININA" id="sub4" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub4">Creatinina</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="COLESTEROL_TOTAL" id="sub5" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub5">Colesterol Total</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="HDL" id="sub6" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub6">HDL</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="LDL" id="sub7" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub7">LDL</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="TRIGLICERIDEOS" id="sub8" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub8">Triglicerídeos</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="TGO_AST" id="sub9" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub9">TGO (AST)</label></div>
                        <div class="col-md-4 form-check mb-2 ms-3"><input class="form-check-input" type="checkbox" value="TGP_ALT" id="sub10" th:field="*{subExamesSelecionados}"><label class="form-check-label" for="sub10">TGP (ALT)</label></div>
                        </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Dados do Paciente e Médico</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="pacienteNome" class="form-label">Nome do Paciente:</label><input type="text" id="pacienteNome" class="form-control" th:field="*{pacienteNome}"/></div>
                        <div class="col-md-6 mb-3"><label for="convenio" class="form-label">Convênio:</label><input type="text" id="convenio" class="form-control" th:field="*{convenio}"/></div>
                        <div class="col-md-6 mb-3"><label for="medicoSolicitante" class="form-label">Médico Solicitante:</label><input type="text" id="medicoSolicitante" class="form-control" th:field="*{medicoSolicitante}"/></div>
                        <div class="col-md-6 mb-3"><label for="medicoResponsavel" class="form-label">Médico Responsável:</label><input type="text" id="medicoResponsavel" class="form-control" th:field="*{medicoResponsavel}"/></div>
                        <div class="col-md-6 mb-3"><label for="crmResponsavel" class="form-label">CRM Responsável:</label><input type="text" id="crmResponsavel" class="form-control" th:field="*{crmResponsavel}"/></div>
                    </div>
                </div>
            </div>

            <div id="contextoContainer" class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Contexto Clínico (para exames individuais)</h5>
                    <div class="row">
                         <div class="col-md-4 mb-3"><label class="form-label">Valor (ex: glicose):</label><input type="number" step="any" class="form-control" th:field="*{contexto.valor}"/></div>
                         <div class="col-md-4 mb-3"><label class="form-label">Unidade:</label><input type="text" class="form-control" th:field="*{contexto.unidade}"/></div>
                         <div class="col-md-4 mb-3"><label class="form-label">Idade:</label><input type="number" class="form-control" th:field="*{contexto.idade}"/></div>
                         <div class="col-md-4 mb-3"><label class="form-label">Sexo:</label><input type="text" class="form-control" th:field="*{contexto.sexo}"/></div>
                         <div class="col-md-8 mb-3"><label class="form-label">Protocolo (RM):</label><input type="text" class="form-control" th:field="*{contexto.protocolo}"/></div>
                         <div class="col-md-6 mb-3"><label class="form-label">Radiologista (assinatura):</label><input type="text" class="form-control" th:field="*{contexto.radiologistaAssinatura}"/></div>
                         <div class="col-md-6 mb-3"><label class="form-label">Contraste Utilizado:</label><input type="text" class="form-control" th:field="*{contexto.contraste}"/></div>
                         <div class="col-md-4 mb-3"><label class="form-label">Dose do Contraste:</label><input type="text" class="form-control" th:field="*{contexto.doseContraste}"/></div>
                         <div class="col-md-4 d-flex align-items-center mt-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="implantes" th:field="*{contexto.pacienteComImplantesMetalicos}"><label class="form-check-label" for="implantes">Paciente com implantes?</label></div></div>
                         <div class="col-md-4 d-flex align-items-center mt-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="contraste" th:field="*{contexto.usouContraste}"><label class="form-check-label" for="contraste">Usou contraste?</label></div></div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-end">
                <p th:if="${erro}" th:text="${erro}" class="text-danger text-start"></p>
                <button type="submit" class="btn btn-primary btn-lg px-5">Gerar Laudo</button>
            </div>
            
        </form>
    </div>

    <script>
        function toggleSections() {
            var tipoExame = document.getElementById('tipoExame').value;
            var subExamesDiv = document.getElementById('subExamesContainer');
            var contextoDiv = document.getElementById('contextoContainer');

            if (tipoExame === 'HEMOGRAMA_AGRUPADO') {
                subExamesDiv.style.display = 'block'; // Mostra checkboxes
                contextoDiv.style.display = 'none';  // Esconde campos de contexto
            } else {
                subExamesDiv.style.display = 'none';   // Esconde checkboxes
                contextoDiv.style.display = 'block'; // Mostra campos de contexto
            }
        }
        // Executa a função assim que a página carregar para garantir o estado inicial correto
        document.addEventListener('DOMContentLoaded', toggleSections);
    </script>
</body>
</html>